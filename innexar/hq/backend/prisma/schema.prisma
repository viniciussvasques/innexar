// INNEXAR - Sistema de Afiliados Multi-SaaS
// Banco de dados independente

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// PRODUTOS SAAS
// =====================================================

model SaaSProduct {
  id              String   @id @default(uuid())
  code            String   @unique @db.VarChar(50) // mecanica365, crm_hub, etc.
  name            String   @db.VarChar(100)
  description     String?  @db.Text
  logoUrl         String?  @map("logo_url") @db.VarChar(500)
  baseUrl         String   @map("base_url") @db.VarChar(255)
  checkoutUrl     String?  @map("checkout_url") @db.VarChar(500)
  commissionRate  Decimal  @default(0.10) @map("commission_rate") @db.Decimal(5, 4) // 10% default
  cookieDays      Int      @default(30) @map("cookie_days") // Dias de cookie tracking
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  affiliateLinks AffiliateLink[]
  
  @@map("saas_products")
}

// =====================================================
// AFILIADOS
// =====================================================

model Affiliate {
  id            String    @id @default(uuid())
  name          String    @db.VarChar(255)
  email         String    @unique @db.VarChar(255)
  password      String    @db.VarChar(255)
  phone         String?   @db.VarChar(20)
  cpfCnpj       String?   @map("cpf_cnpj") @db.VarChar(20)
  
  // Dados de pagamento
  pixKey        String?   @map("pix_key") @db.VarChar(255)
  pixKeyType    String?   @map("pix_key_type") @db.VarChar(20) // cpf, email, phone, random
  bankName      String?   @map("bank_name") @db.VarChar(100)
  bankAgency    String?   @map("bank_agency") @db.VarChar(10)
  bankAccount   String?   @map("bank_account") @db.VarChar(20)
  
  // Status e controle
  status        String    @default("pending") @db.VarChar(50) // pending, active, blocked
  approvedAt    DateTime? @map("approved_at")
  approvedBy    String?   @map("approved_by") @db.VarChar(255)
  
  // Termos
  acceptedTermsAt DateTime? @map("accepted_terms_at")
  
  // Tracking
  referralCode    String?  @unique @map("referral_code") @db.VarChar(50) // Código único do afiliado
  referredBy      String?  @map("referred_by") // ID do afiliado que indicou
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")

  links         AffiliateLink[]
  commissions   AffiliateCommission[]
  visits        AffiliateVisit[]
  withdrawals   AffiliateWithdrawal[]

  @@index([status])
  @@index([email])
  @@index([referralCode])
  @@map("affiliates")
}

// =====================================================
// LINKS DE AFILIADOS
// =====================================================

model AffiliateLink {
  id          String   @id @default(uuid())
  affiliateId String   @map("affiliate_id")
  productId   String   @map("product_id")
  code        String   @unique @db.VarChar(50) // Código único de rastreio
  customSlug  String?  @map("custom_slug") @db.VarChar(100) // Slug personalizado opcional
  targetUrl   String   @map("target_url") @db.Text
  
  // Estatísticas (cache para performance)
  totalClicks     Int @default(0) @map("total_clicks")
  uniqueClicks    Int @default(0) @map("unique_clicks")
  conversions     Int @default(0)
  
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  affiliate   Affiliate     @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  product     SaaSProduct   @relation(fields: [productId], references: [id], onDelete: Cascade)
  visits      AffiliateVisit[]
  commissions AffiliateCommission[]

  @@index([affiliateId])
  @@index([productId])
  @@index([code])
  @@map("affiliate_links")
}

// =====================================================
// VISITAS/CLIQUES
// =====================================================

model AffiliateVisit {
  id            String   @id @default(uuid())
  linkId        String   @map("link_id")
  affiliateId   String   @map("affiliate_id")
  
  // Dados do visitante
  ip            String?  @db.VarChar(50)
  userAgent     String?  @map("user_agent") @db.Text
  referrer      String?  @db.Text
  country       String?  @db.VarChar(2)
  city          String?  @db.VarChar(100)
  device        String?  @db.VarChar(50) // mobile, desktop, tablet
  browser       String?  @db.VarChar(50)
  os            String?  @db.VarChar(50)
  
  // Tracking
  sessionId     String?  @map("session_id") @db.VarChar(100)
  isUnique      Boolean  @default(true) @map("is_unique")
  converted     Boolean  @default(false)
  convertedAt   DateTime? @map("converted_at")
  
  createdAt     DateTime @default(now()) @map("created_at")

  link          AffiliateLink @relation(fields: [linkId], references: [id], onDelete: Cascade)
  affiliate     Affiliate     @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@index([linkId])
  @@index([affiliateId])
  @@index([createdAt])
  @@index([sessionId])
  @@map("affiliate_visits")
}

// =====================================================
// COMISSÕES
// =====================================================

model AffiliateCommission {
  id          String   @id @default(uuid())
  affiliateId String   @map("affiliate_id")
  linkId      String   @map("link_id")
  
  // Valores
  saleAmount    Decimal  @map("sale_amount") @db.Decimal(10, 2) // Valor da venda
  commissionRate Decimal @map("commission_rate") @db.Decimal(5, 4) // Taxa aplicada
  amount        Decimal  @db.Decimal(10, 2) // Valor da comissão
  
  // Status: pending -> approved -> paid (ou cancelled)
  status        String   @default("pending") @db.VarChar(50)
  
  // Referência externa
  orderId       String?  @map("order_id") @db.VarChar(255)
  orderDetails  Json?    @map("order_details")
  customerEmail String?  @map("customer_email") @db.VarChar(255)
  
  // Datas
  createdAt     DateTime @default(now()) @map("created_at")
  approvedAt    DateTime? @map("approved_at")
  paidAt        DateTime? @map("paid_at")
  cancelledAt   DateTime? @map("cancelled_at")
  
  // Quem processou
  processedBy   String?  @map("processed_by") @db.VarChar(255)
  notes         String?  @db.Text

  affiliate     Affiliate     @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  link          AffiliateLink @relation(fields: [linkId], references: [id], onDelete: Cascade)

  @@index([affiliateId])
  @@index([status])
  @@index([createdAt])
  @@map("affiliate_commissions")
}

// =====================================================
// SAQUES
// =====================================================

model AffiliateWithdrawal {
  id          String   @id @default(uuid())
  affiliateId String   @map("affiliate_id")
  
  amount      Decimal  @db.Decimal(10, 2)
  method      String   @db.VarChar(50) // pix, bank_transfer
  
  // Dados de pagamento no momento do saque
  pixKey        String?  @map("pix_key") @db.VarChar(255)
  bankName      String?  @map("bank_name") @db.VarChar(100)
  bankAgency    String?  @map("bank_agency") @db.VarChar(10)
  bankAccount   String?  @map("bank_account") @db.VarChar(20)
  
  // Status: pending -> processing -> completed (ou rejected)
  status        String   @default("pending") @db.VarChar(50)
  
  // Comprovante
  receiptUrl    String?  @map("receipt_url") @db.VarChar(500)
  transactionId String?  @map("transaction_id") @db.VarChar(255)
  
  // Datas e processamento
  createdAt     DateTime @default(now()) @map("created_at")
  processedAt   DateTime? @map("processed_at")
  completedAt   DateTime? @map("completed_at")
  processedBy   String?  @map("processed_by") @db.VarChar(255)
  
  notes         String?  @db.Text
  rejectionReason String? @map("rejection_reason") @db.Text

  affiliate     Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@index([affiliateId])
  @@index([status])
  @@index([createdAt])
  @@map("affiliate_withdrawals")
}

// =====================================================
// USUÁRIOS E EQUIPE (Antigo Admin)
// =====================================================

enum Role {
  SUPER_ADMIN
  ADMIN
  SUPPORT
  MARKETING
  FINANCE
  DEV
}

model User {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(255)
  email     String   @unique @db.VarChar(255)
  password  String   @db.VarChar(255)
  role      Role     @default(ADMIN)
  avatarUrl String?  @map("avatar_url") @db.VarChar(500)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  ticketsAssigned  Ticket[]      @relation("AssignedTickets")
  ticketsCreated   Ticket[]      @relation("CreatedTickets") // Tickets internos
  ticketMessages   TicketMessage[]
  campaigns        Campaign[]
  
  @@map("users")
}

// =====================================================
// SUPORTE (Tickets)
// =====================================================

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CUSTOMER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Ticket {
  id            String         @id @default(uuid())
  subject       String         @db.VarChar(255)
  description   String         @db.Text
  status        TicketStatus   @default(OPEN)
  priority      TicketPriority @default(MEDIUM)
  
  // Origem do ticket
  source        String?        @db.VarChar(50) // email, chat, form
  customerEmail String?        @map("customer_email") @db.VarChar(255)
  customerId    String?        @map("customer_id") @db.VarChar(255) // ID externo (do SaaS)
  
  // Atribuição
  assignedToId  String?        @map("assigned_to_id")
  createdById   String?        @map("created_by_id") // Se criado por usuário interno
  
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  resolvedAt    DateTime?      @map("resolved_at")

  assignedTo    User?          @relation("AssignedTickets", fields: [assignedToId], references: [id])
  createdBy     User?          @relation("CreatedTickets", fields: [createdById], references: [id])
  messages      TicketMessage[]

  @@map("tickets")
}

model TicketMessage {
  id        String   @id @default(uuid())
  ticketId  String   @map("ticket_id")
  userId    String?  @map("user_id") // Null se for resposta do cliente/sistema externo
  
  content   String   @db.Text
  isInternal Boolean @default(false) @map("is_internal") // Notas internas
  
  createdAt DateTime @default(now()) @map("created_at")
  
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@map("ticket_messages")
}

// =====================================================
// MARKETING (Campanhas)
// =====================================================

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
}

model Campaign {
  id          String         @id @default(uuid())
  name        String         @db.VarChar(255)
  description String?        @db.Text
  type        String         @db.VarChar(50) // email, social, ads
  status      CampaignStatus @default(DRAFT)
  
  startDate   DateTime?      @map("start_date")
  endDate     DateTime?      @map("end_date")
  budget      Decimal?       @db.Decimal(10, 2)
  
  createdById String         @map("created_by_id")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  createdBy   User           @relation(fields: [createdById], references: [id])
  leads       Lead[]

  @@map("campaigns")
}

model Lead {
  id          String   @id @default(uuid())
  email       String   @unique @db.VarChar(255)
  name        String?  @db.VarChar(255)
  phone       String?  @db.VarChar(20)
  source      String?  @db.VarChar(50)
  
  campaignId  String?  @map("campaign_id")
  status      String   @default("new") @db.VarChar(50) // new, contacted, qualified, converted
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  campaign    Campaign? @relation(fields: [campaignId], references: [id])

  @@map("leads")
}

// =====================================================
// FINANCEIRO (Billing & Assinaturas)
// =====================================================

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
}

model Plan {
  id            String   @id @default(uuid())
  name          String   @db.VarChar(100)
  price         Decimal  @db.Decimal(10, 2)
  billingPeriod String   @map("billing_period") @db.VarChar(20) // monthly, yearly
  features      Json?
  
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  subscriptions Subscription[]

  @@map("plans")
}

model Subscription {
  id            String             @id @default(uuid())
  customerId    String             @map("customer_id") @db.VarChar(255) // ID externo do cliente (SaaS)
  planId        String             @map("plan_id")
  
  status        SubscriptionStatus @default(ACTIVE)
  startDate     DateTime           @map("start_date")
  currentPeriodEnd DateTime        @map("current_period_end")
  
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")
  
  plan          Plan               @relation(fields: [planId], references: [id])
  invoices      Invoice[]

  @@map("subscriptions")
}

model Invoice {
  id             String   @id @default(uuid())
  subscriptionId String   @map("subscription_id")
  amount         Decimal  @db.Decimal(10, 2)
  status         String   @db.VarChar(50) // paid, open, void, uncollectible
  
  dueDate        DateTime @map("due_date")
  paidAt         DateTime? @map("paid_at")
  
  pdfUrl         String?  @map("pdf_url") @db.VarChar(500)
  
  createdAt      DateTime @default(now()) @map("created_at")
  
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])

  @@map("invoices")
}

// =====================================================
// CONFIGURAÇÕES DO SISTEMA
// =====================================================

model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique @db.VarChar(100)
  value     String   @db.Text
  type      String   @default("string") @db.VarChar(50) // string, number, boolean, json
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_configs")
}

